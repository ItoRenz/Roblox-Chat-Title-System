-- ========================================
-- CHAT TITLE SYSTEM - CLIENT
-- Author: ItoRenz00, Modified by Claude
-- Version: 1.1.0
-- Description:
-- Displays custom colored titles based on player roles from server.
-- Place this LocalScript in StarterPlayer > StarterPlayerScripts
-- ========================================

local TextChatService = game:GetService("TextChatService")
local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")

local player = Players.LocalPlayer
local RoleEvent = ReplicatedStorage:WaitForChild("GetPlayerRole")
local PlayerRoles = {}

local ROLE_REQUEST_DELAY = 1
local NEW_PLAYER_DELAY = 0.5
local DEFAULT_COLOR = Color3.fromRGB(255, 255, 255)

local function requestPlayerRole(targetPlayer)
	if targetPlayer and targetPlayer.Name then
		RoleEvent:FireServer("RequestRole", targetPlayer.Name)
	end
end

local function requestAllPlayerRoles()
	for _, otherPlayer in ipairs(Players:GetPlayers()) do
		requestPlayerRole(otherPlayer)
	end
end

local function formatChatMessage(message)
	local textSource = message.TextSource
	if not textSource then return nil end
	
	local sourcePlayer = Players:GetPlayerByUserId(textSource.UserId)
	if not sourcePlayer then return nil end
	
	local role = PlayerRoles[sourcePlayer.Name]
	local properties = Instance.new("TextChatMessageProperties")
	
	if role then
		local title = role[1]
		local color = role[2]
		properties.PrefixText = string.format(
			'<font color="rgb(%d,%d,%d)">[%s] %s:</font> ',
			math.floor(color.R * 255),
			math.floor(color.G * 255),
			math.floor(color.B * 255),
			title,
			sourcePlayer.DisplayName
		)
	else
		properties.PrefixText = string.format(
			'<font color="rgb(255,255,255)">%s:</font> ',
			sourcePlayer.DisplayName
		)
	end
	
	return properties
end

local loggedRoles = {}

RoleEvent.OnClientEvent:Connect(function(action, playerName, role)
	if action == "UpdateRole" and role and playerName then
		PlayerRoles[playerName] = role
		if loggedRoles[playerName] ~= role[1] then
			loggedRoles[playerName] = role[1]
			print(string.format("[Chat Title] Role updated for %s: [%s]", playerName, role[1]))
		end
	elseif action == "RemoveRole" and playerName then
		PlayerRoles[playerName] = nil
		if loggedRoles[playerName] then
			loggedRoles[playerName] = nil
			print(string.format("[Chat Title] Role removed for %s", playerName))
		end
	end
end)

Players.PlayerAdded:Connect(function(newPlayer)
	task.wait(NEW_PLAYER_DELAY)
	requestPlayerRole(newPlayer)
end)

Players.PlayerRemoving:Connect(function(leavingPlayer)
	PlayerRoles[leavingPlayer.Name] = nil
	loggedRoles[leavingPlayer.Name] = nil
end)

TextChatService.OnIncomingMessage = formatChatMessage

task.wait(ROLE_REQUEST_DELAY)
requestAllPlayerRoles()

print("[Chat Title System] Client successfully loaded! Ready to show titles.")
print("Author: ItoRenz00")
