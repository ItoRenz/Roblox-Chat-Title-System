-- ========================================
-- CHAT TITLE SYSTEM - LOCAL SCRIPT (CLIENT)
-- Author: ItoRenz00
-- Place this script in StarterPlayer > StarterPlayerScripts
-- ========================================

local TextChatService = game:GetService("TextChatService")
local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")

local player = Players.LocalPlayer

-- Wait for RemoteEvent to be ready
local RoleEvent = ReplicatedStorage:WaitForChild("GetPlayerRole")

-- Table to store all player roles
local PlayerRoles = {}

-- Receive role data from server
RoleEvent.OnClientEvent:Connect(function(playerName, role)
    if role then
        PlayerRoles[playerName] = role
        print("Role received for " .. playerName .. ": [" .. role[1] .. "]")
    end
end)

-- Request all player roles from server
task.wait(1)
for _, otherPlayer in pairs(Players:GetPlayers()) do
    RoleEvent:FireServer(otherPlayer.Name)
end

-- Monitor newly joined players
Players.PlayerAdded:Connect(function(newPlayer)
    task.wait(0.5)
    RoleEvent:FireServer(newPlayer.Name)
end)

-- Setup chat message with title
TextChatService.OnIncomingMessage = function(message)
    local textSource = message.TextSource
    if textSource then
        local sourcePlayer = Players:GetPlayerByUserId(textSource.UserId)
        if sourcePlayer then
            local role = PlayerRoles[sourcePlayer.Name]
            if role then
                local title = role[1]
                local color = role[2]
                
                -- Create properties for chat
                local properties = Instance.new("TextChatMessageProperties")
                
                -- Format: [Title] DisplayName: message
                -- Display name and title have the same color
                properties.PrefixText = string.format(
                    '<font color="rgb(%d,%d,%d)">[%s] %s:</font> ',
                    math.floor(color.R * 255),
                    math.floor(color.G * 255),
                    math.floor(color.B * 255),
                    title,
                    sourcePlayer.DisplayName
                )
                
                return properties
            end
        end
    end
end

print("Chat Title System (Client) successfully loaded!")
