-- ========================================
-- LOCAL SCRIPT (CLIENT)
-- Letakkan script ini di StarterPlayer > StarterPlayerScripts
-- ========================================

local TextChatService = game:GetService("TextChatService")
local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")

local player = Players.LocalPlayer

-- Tunggu RemoteEvent siap
local RoleEvent = ReplicatedStorage:WaitForChild("GetPlayerRole")

-- Tabel untuk menyimpan role semua player
local PlayerRoles = {}

-- Terima data role dari server
RoleEvent.OnClientEvent:Connect(function(playerName, role)
    if role then
        PlayerRoles[playerName] = role
        print("Role diterima untuk " .. playerName .. ": [" .. role[1] .. "]")
    end
end)

-- Minta role semua player dari server
task.wait(1)
for _, otherPlayer in pairs(Players:GetPlayers()) do
    RoleEvent:FireServer(otherPlayer.Name)
end

-- Monitor player baru yang join
Players.PlayerAdded:Connect(function(newPlayer)
    task.wait(0.5)
    RoleEvent:FireServer(newPlayer.Name)
end)

-- Setup chat message dengan title
TextChatService.OnIncomingMessage = function(message)
    local textSource = message.TextSource
    if textSource then
        local sourcePlayer = Players:GetPlayerByUserId(textSource.UserId)
        if sourcePlayer then
            local role = PlayerRoles[sourcePlayer.Name]
            if role then
                local title = role[1]
                local color = role[2]
                
                -- Buat properties untuk chat
                local properties = Instance.new("TextChatMessageProperties")
                
                -- Format: [Title] DisplayName: message
                -- Display name dan title memiliki warna yang sama
                properties.PrefixText = string.format(
                    '<font color="rgb(%d,%d,%d)">[%s] %s:</font> ',
                    math.floor(color.R * 255),
                    math.floor(color.G * 255),
                    math.floor(color.B * 255),
                    title,
                    sourcePlayer.DisplayName
                )
                
                return properties
            end
        end
    end
end

print("Chat Title System (Client) berhasil dimuat!")
